import type { Express } from \"express\";\nimport { z } from \"zod\";\nimport { storage } from \"../storage\";\nimport MicrosoftTeamsService from \"../services/microsoft-teams\";\nimport { requireAuth, requireRole } from \"../middleware/auth\";\nimport { requireOrganization } from \"../middleware/organization\";\n\nexport function registerMicrosoftTeamsRoutes(app: Express): void {\n  \n  // Get Teams integration status\n  app.get(\"/api/teams-integration/status\", requireOrganization(), async (req, res) => {\n    try {\n      const organization = await storage.getOrganization(req.orgId);\n      if (!organization) {\n        return res.status(404).json({ message: \"Organization not found\" });\n      }\n      \n      res.json({\n        enabled: organization.enableTeamsIntegration,\n        configured: MicrosoftTeamsService.isConfigured(organization.microsoftTeamsWebhookUrl),\n        webhookUrl: organization.microsoftTeamsWebhookUrl ? '***configured***' : null\n      });\n    } catch (error) {\n      console.error(\"Teams integration status error:\", error);\n      res.status(500).json({ message: \"Failed to get Teams integration status\" });\n    }\n  });\n  \n  // Configure Teams integration (admin only)\n  app.put(\"/api/teams-integration/settings\", requireAuth(), requireRole('admin'), requireOrganization(), async (req, res) => {\n    try {\n      const settingsSchema = z.object({\n        enableTeamsIntegration: z.boolean().optional(),\n        microsoftTeamsWebhookUrl: z.string().url().optional().or(z.literal(''))\n      });\n      \n      const validatedData = settingsSchema.parse(req.body);\n      \n      const updateData: any = {};\n      if (typeof validatedData.enableTeamsIntegration === 'boolean') {\n        updateData.enableTeamsIntegration = validatedData.enableTeamsIntegration;\n      }\n      if (validatedData.microsoftTeamsWebhookUrl !== undefined) {\n        updateData.microsoftTeamsWebhookUrl = validatedData.microsoftTeamsWebhookUrl || null;\n      }\n      \n      const organization = await storage.updateOrganization(req.orgId, updateData);\n      \n      if (!organization) {\n        return res.status(404).json({ message: \"Organization not found\" });\n      }\n      \n      res.json({\n        enableTeamsIntegration: organization.enableTeamsIntegration,\n        webhookConfigured: !!organization.microsoftTeamsWebhookUrl\n      });\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid settings data\", errors: error.errors });\n      }\n      console.error(\"Teams integration settings error:\", error);\n      res.status(500).json({ message: \"Failed to update Teams integration settings\" });\n    }\n  });\n  \n  // Test Teams webhook\n  app.post(\"/api/teams-integration/test\", requireAuth(), requireRole('admin'), requireOrganization(), async (req, res) => {\n    try {\n      const organization = await storage.getOrganization(req.orgId);\n      if (!organization) {\n        return res.status(404).json({ message: \"Organization not found\" });\n      }\n      \n      if (!organization.enableTeamsIntegration || !organization.microsoftTeamsWebhookUrl) {\n        return res.status(400).json({ message: \"Teams integration not configured\" });\n      }\n      \n      const teamsService = new MicrosoftTeamsService();\n      const success = await teamsService.validateWebhookUrl(organization.microsoftTeamsWebhookUrl);\n      \n      if (success) {\n        res.json({ success: true, message: \"Test message sent successfully to Teams\" });\n      } else {\n        res.status(400).json({ success: false, message: \"Failed to send test message to Teams\" });\n      }\n    } catch (error) {\n      console.error(\"Teams webhook test error:\", error);\n      res.status(500).json({ message: \"Failed to test Teams webhook\" });\n    }\n  });\n  \n  // Send custom message to Teams (admin/manager only)\n  app.post(\"/api/teams-integration/message\", requireAuth(), requireRole('admin'), requireOrganization(), async (req, res) => {\n    try {\n      const messageSchema = z.object({\n        title: z.string().optional(),\n        text: z.string().min(1),\n        themeColor: z.string().optional()\n      });\n      \n      const validatedData = messageSchema.parse(req.body);\n      \n      const organization = await storage.getOrganization(req.orgId);\n      if (!organization) {\n        return res.status(404).json({ message: \"Organization not found\" });\n      }\n      \n      if (!organization.enableTeamsIntegration || !organization.microsoftTeamsWebhookUrl) {\n        return res.status(400).json({ message: \"Teams integration not configured\" });\n      }\n      \n      const teamsService = new MicrosoftTeamsService();\n      const success = await teamsService.sendMessageToWebhook(\n        organization.microsoftTeamsWebhookUrl,\n        validatedData\n      );\n      \n      if (success) {\n        res.json({ success: true, message: \"Message sent successfully to Teams\" });\n      } else {\n        res.status(400).json({ success: false, message: \"Failed to send message to Teams\" });\n      }\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid message data\", errors: error.errors });\n      }\n      console.error(\"Teams message send error:\", error);\n      res.status(500).json({ message: \"Failed to send message to Teams\" });\n    }\n  });\n  \n  // Get available Teams channels (requires user authentication with Microsoft)\n  app.get(\"/api/teams-integration/channels\", requireAuth(), requireOrganization(), async (req, res) => {\n    try {\n      // Check if user has Microsoft tokens in session\n      const microsoftTokens = req.session.microsoftTokens;\n      if (!microsoftTokens) {\n        return res.status(401).json({ \n          message: \"Microsoft authentication required\",\n          redirectUrl: `/auth/microsoft`\n        });\n      }\n      \n      const teamsService = new MicrosoftTeamsService(microsoftTokens.accessToken);\n      const channels = await teamsService.getUserTeamsChannels();\n      \n      res.json(channels);\n    } catch (error) {\n      console.error(\"Teams channels fetch error:\", error);\n      if (error.message.includes('authentication')) {\n        return res.status(401).json({ \n          message: \"Microsoft authentication expired\",\n          redirectUrl: `/auth/microsoft`\n        });\n      }\n      res.status(500).json({ message: \"Failed to fetch Teams channels\" });\n    }\n  });\n}