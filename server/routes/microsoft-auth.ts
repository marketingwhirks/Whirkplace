import type { Express } from \"express\";\nimport { randomBytes } from \"crypto\";\nimport { z } from \"zod\";\nimport { storage } from \"../storage\";\nimport { microsoftAuthService } from \"../services/microsoft-auth\";\nimport { requireOrganization } from \"../middleware/organization\";\nimport type { InsertUser } from \"@shared/schema\";\n\ninterface MicrosoftTokenData {\n  accessToken: string;\n  account: {\n    homeAccountId: string;\n    localAccountId: string;\n    username: string;\n    name: string;\n    tenantId: string;\n  };\n}\n\nexport function registerMicrosoftAuthRoutes(app: Express): void {\n  \n  // Microsoft OAuth initiation\n  app.get(\"/auth/microsoft\", requireOrganization(), async (req, res) => {\n    try {\n      // Check if Microsoft auth is configured and enabled for this organization\n      const organization = await storage.getOrganization(req.orgId);\n      if (!organization) {\n        return res.status(404).json({ message: \"Organization not found\" });\n      }\n      \n      if (!organization.enableMicrosoftAuth) {\n        return res.status(403).json({ \n          message: \"Microsoft authentication is not enabled for this organization\" \n        });\n      }\n      \n      if (!microsoftAuthService.isConfigured()) {\n        return res.status(500).json({ \n          message: \"Microsoft authentication is not configured on this server\" \n        });\n      }\n      \n      // Generate random state for CSRF protection\n      const state = randomBytes(32).toString('hex');\n      req.session.microsoftAuthState = state;\n      req.session.authOrgId = req.orgId; // Store org ID for callback\n      \n      const authUrl = await microsoftAuthService.getAuthUrl(state);\n      res.redirect(authUrl);\n    } catch (error) {\n      console.error(\"Microsoft auth initiation error:\", error);\n      res.status(500).json({ message: \"Failed to initiate Microsoft authentication\" });\n    }\n  });\n  \n  // Microsoft OAuth callback\n  app.get(\"/auth/microsoft/callback\", async (req, res) => {\n    try {\n      const { code, state, error: authError } = req.query;\n      \n      // Handle OAuth errors\n      if (authError) {\n        console.error(\"Microsoft OAuth error:\", authError);\n        return res.redirect(`/login?error=microsoft_auth_failed`);\n      }\n      \n      // Validate state parameter for CSRF protection\n      if (!state || state !== req.session.microsoftAuthState) {\n        console.error(\"Microsoft auth state mismatch\");\n        return res.redirect(`/login?error=invalid_state`);\n      }\n      \n      if (!code) {\n        return res.redirect(`/login?error=no_authorization_code`);\n      }\n      \n      // Get organization ID from session\n      const orgId = req.session.authOrgId;\n      if (!orgId) {\n        return res.redirect(`/login?error=missing_organization`);\n      }\n      \n      // Exchange code for token\n      const tokenResponse = await microsoftAuthService.exchangeCodeForToken(code as string, state as string);\n      \n      // Get user profile from Microsoft Graph\n      const userProfile = await microsoftAuthService.getUserProfile(tokenResponse.accessToken);\n      \n      // Check if user exists in our system\n      let user = await storage.getUserByEmail(orgId, userProfile.mail);\n      \n      if (!user) {\n        // Create new user account\n        const newUserData: InsertUser = {\n          username: userProfile.userPrincipalName.split('@')[0], // Use UPN prefix as username\n          password: randomBytes(32).toString('hex'), // Random password (not used for Microsoft auth)\n          name: userProfile.displayName,\n          email: userProfile.mail,\n          role: \"member\",\n          authProvider: \"microsoft\",\n          microsoftUserId: userProfile.id,\n          microsoftUserPrincipalName: userProfile.userPrincipalName,\n          microsoftDisplayName: userProfile.displayName,\n          microsoftEmail: userProfile.mail,\n          microsoftTenantId: tokenResponse.account.tenantId,\n          isActive: true\n        };\n        \n        user = await storage.createUser(orgId, newUserData);\n      } else {\n        // Update existing user with Microsoft profile data\n        await storage.updateUser(orgId, user.id, {\n          microsoftUserId: userProfile.id,\n          microsoftUserPrincipalName: userProfile.userPrincipalName,\n          microsoftDisplayName: userProfile.displayName,\n          microsoftEmail: userProfile.mail,\n          microsoftTenantId: tokenResponse.account.tenantId,\n          authProvider: \"microsoft\"\n        });\n        \n        // Fetch updated user\n        user = await storage.getUser(orgId, user.id);\n      }\n      \n      if (!user) {\n        return res.redirect(`/login?error=user_creation_failed`);\n      }\n      \n      // Set session\n      req.session.userId = user.id;\n      req.session.organizationId = orgId;\n      req.session.microsoftTokens = {\n        accessToken: tokenResponse.accessToken,\n        account: tokenResponse.account\n      } as MicrosoftTokenData;\n      \n      // Clear auth state\n      delete req.session.microsoftAuthState;\n      delete req.session.authOrgId;\n      \n      console.log(`Microsoft SSO login successful for user: ${user.email}`);\n      \n      // Redirect to dashboard\n      res.redirect('/dashboard');\n    } catch (error) {\n      console.error(\"Microsoft auth callback error:\", error);\n      res.redirect(`/login?error=microsoft_auth_callback_failed`);\n    }\n  });\n  \n  // Microsoft logout\n  app.get(\"/auth/microsoft/logout\", (req, res) => {\n    try {\n      const logoutUrl = microsoftAuthService.getLogoutUrl(`${process.env.REPL_URL || 'http://localhost:5000'}/login`);\n      \n      // Clear session\n      req.session.destroy((err) => {\n        if (err) {\n          console.error('Session destruction error:', err);\n        }\n        res.redirect(logoutUrl);\n      });\n    } catch (error) {\n      console.error(\"Microsoft logout error:\", error);\n      res.redirect('/login');\n    }\n  });\n  \n  // Get Microsoft auth status\n  app.get(\"/api/auth/microsoft/status\", requireOrganization(), async (req, res) => {\n    try {\n      const organization = await storage.getOrganization(req.orgId);\n      if (!organization) {\n        return res.status(404).json({ message: \"Organization not found\" });\n      }\n      \n      res.json({\n        enabled: organization.enableMicrosoftAuth,\n        configured: microsoftAuthService.isConfigured(),\n        tenantId: organization.microsoftTenantId\n      });\n    } catch (error) {\n      console.error(\"Microsoft auth status error:\", error);\n      res.status(500).json({ message: \"Failed to get Microsoft auth status\" });\n    }\n  });\n  \n  // Enable/disable Microsoft auth for organization (admin only)\n  app.put(\"/api/auth/microsoft/settings\", requireOrganization(), async (req, res) => {\n    try {\n      // This would need proper admin authentication middleware\n      // For now, we'll implement a basic version\n      \n      const { enableMicrosoftAuth, microsoftTenantId } = req.body;\n      \n      const updateData: any = {};\n      if (typeof enableMicrosoftAuth === 'boolean') {\n        updateData.enableMicrosoftAuth = enableMicrosoftAuth;\n      }\n      if (typeof microsoftTenantId === 'string') {\n        updateData.microsoftTenantId = microsoftTenantId;\n      }\n      \n      const organization = await storage.updateOrganization(req.orgId, updateData);\n      \n      if (!organization) {\n        return res.status(404).json({ message: \"Organization not found\" });\n      }\n      \n      res.json({\n        enableMicrosoftAuth: organization.enableMicrosoftAuth,\n        microsoftTenantId: organization.microsoftTenantId\n      });\n    } catch (error) {\n      console.error(\"Microsoft auth settings error:\", error);\n      res.status(500).json({ message: \"Failed to update Microsoft auth settings\" });\n    }\n  });\n}